#!/usr/bin/env ruby

require 'date'

require_relative 'bootstrap_ar'
database = ENV['KTB_ENV'] || 'development'
connect_to database

command = ARGV[0]

user_name = ARGV[1]
params = { command: command, user: { name: user_name } }
user_controller = UserController.new(params)

user_id = ARGV[1]
daily_params = { command: command, daily_check_in: { user_id: user_id } }
daily_check_in_controller = DailyCheckInController.new(daily_params)

if command == "add"
  user_controller.add
elsif command == "list"
  user_controller.list
elsif command == "remove"
  user_controller.remove
elsif command == "remove_all"
  user_controller.remove_all

elsif command == "list_daily"
  daily_check_in_controller.list
elsif command == "remove_daily"
  daily_check_in_controller.remove
elsif command == "remove_all_daily"
  daily_check_in_controller.remove_all
end

def commentary(genre)
  insults = ["moron", "numb nuts", "dip shit", "idiot", "dummy", "fool", "cheese dick", "douche", "dick flap", "turd burgler", "scuzz bucket", "scumbag", "dunce", "lame brain", "ass", "bone head", "block head", "dimwit"]
  compliments = ["boss", "beast", "bonus", "rad", "righteous", "dope", "super", "wicked", "groovy", "terrific", "fantastic", "outstanding", "bravo", "well done"]
  `say "#{insults.sample}"` if genre == "insult"
  `say "#{compliments.sample}"` if genre == "compliment"
end

def welcome
  puts "Welcome to Karma to Burn.\nWhat is your first name?"
  `say "Welcome!"`
  entered_name = gets.chomp.capitalize
  puts "Hello, #{entered_name}. What is your date of birth(mm-dd-yyyy)?"
  entered_date_of_birth = gets.chomp.split('-')
  month = entered_date_of_birth[0]
  month = month.to_i
  month = "%02d" % month
  day = entered_date_of_birth[1]
  day = day.to_i
  day = "%02d" % day
  year = entered_date_of_birth[2]
  entered_date_of_birth = "#{year}-#{month}-#{day}"
  generate_greeting(entered_name, entered_date_of_birth)
end

def date
  time = Time.new
  month = time.month
  month = "%02d" % month
  day = time.day
  day = "%02d" % day
  "#{time.year}-#{month}-#{day}"
end

def generate_greeting(name, date_of_birth)
  if (User.where(name: name).exists? && User.where(date_of_birth: date_of_birth).exists?)
    @current_user = User.where(name: name, date_of_birth: date_of_birth).first
    puts "Welcome back, #{name}.\n"
    check_in
  else
    @current_user = User.create(name: name, date_of_birth: date_of_birth)
    @current_daily_check_in = DailyCheckIn.new(:date => date, :physiological_points => 0, :safety_points => 0, :esteem_points => 0, :love_points => 0, :transcendence_points => 0, :user_id => @current_user.id, :spent_points => 0, :total_points => 0)
    instructions
  end
end

def check_in
  last_check_in = @current_user.daily_check_ins.last.date
  if last_check_in.to_s == date
    @current_daily_check_in = DailyCheckIn.new(:date => date, :physiological_points => 0, :safety_points => 0, :esteem_points => 0, :love_points => 0, :transcendence_points => 0, :user_id => @current_user.id, :spent_points => 0, :total_points => 0)
    puts "Back so soon?\nEnter p to view your progress. Enter s to spend Karma Points. Press enter to exit."
    response = gets.chomp.downcase
    progress if response == "p"
    store if response == "s"
    if response != "p" && response != "s"
      puts "Goodbye"
      exit
    end
  else
    @current_daily_check_in = DailyCheckIn.new(:date => date, :physiological_points => 0, :safety_points => 0, :esteem_points => 0, :love_points => 0, :transcendence_points => 0, :user_id => @current_user.id, :spent_points => 0, :total_points => 0)
    instructions
  end
end

def instructions
  puts "Please assess the following statements. Enter true if you agree and false if you don't.\nPress enter to continue."
  gets
end

def analysis(response, category)
  if response == "true"
    commentary("compliment")
    @current_daily_check_in.increment! category
  elsif response == "false"
    commentary("insult")
    #the following line simply initiates the daily_check_in table. this prevents a nil no-method error from occurring if a user types false for every question. it has no other practical purpose.
    @current_daily_check_in.update_attributes! :spent_points => 0
  else
    puts "Enter true or false, imbecile."
    `say "Imbecile!"`
    @current_daily_check_in.update_attributes! category => 0
    physiological if category == :physiological_points
    safety if category == :safety_points
    esteem if category == :esteem_points
    love if category == :love_points
    transcendence if category == :transcendence_points
  end
end

def physiological
  statements = ["Today, I ate nutritious foods from most, if not all, of the food groups.", "I got enough sleep last night."]
  statements.each do |statement|
    puts statement
    response = gets.chomp.downcase
    analysis(response, :physiological_points)
  end
end

def safety
  statements = ["I did not do anything reckless today. I acted with caution in my daily exploits.", "I did not injure myself today."]
  statements.each do |statement|
    puts statement
    response = gets.chomp.downcase
    analysis(response, :safety_points)
  end
end

def esteem
  statements = ["I am proud of my accomplishments today.", "I look forward to the challenges that tomorrow will bring."]
  statements.each do |statement|
    puts statement
    response = gets.chomp.downcase
    analysis(response, :esteem_points)
  end
end

def love
  statements = ["Today, I attempted to spend time or communicate with people I care about.", "Today, the encounters I had with others were mostly positive."]
  statements.each do |statement|
    puts statement
    response = gets.chomp.downcase
    analysis(response, :love_points)
  end
end

def transcendence
  statements = ["Today, I was curious about the world and my place in it.", "I learned something about myself today, even it is just a little."]
  statements.each do |statement|
    puts statement
    response = gets.chomp.downcase
    analysis(response, :transcendence_points)
  end
end

def daily_points
  current_check_in = DailyCheckIn.where(:date => date, :user_id => @current_user[:id]).first
  todays_points = current_check_in.physiological_points + current_check_in.safety_points + current_check_in.esteem_points + current_check_in.love_points + current_check_in.transcendence_points
  todays_points
end

def total_points
  current_check_in = DailyCheckIn.where(:user_id => @current_user[:id]).all
  past_daily_points = 0
  past_spent_points = 0
  counter = 0
  until counter == current_check_in.length do
    past_daily_points = past_daily_points + current_check_in[counter].physiological_points + current_check_in[counter].safety_points + current_check_in[counter].esteem_points + current_check_in[counter].love_points + current_check_in[counter].transcendence_points
    past_spent_points = past_spent_points + current_check_in[counter].spent_points
    counter += 1
  end
  result = past_daily_points - past_spent_points
end

def total_minutes(karma_points)
  #i have arbitrarily assigned six minutes to one karma point. seems reasonable.
  total_time = karma_points * 6
end

def daily_report
  puts "You have earned #{daily_points} Karma Points today."
  @current_daily_check_in.update_attributes! :total_points => daily_points
end

def store
  puts "You have a total of #{total_points} Karma Points.\nEnter s to spend Karma Points. Enter p to view your progress. Press enter to exit."
  response = gets.chomp.downcase
  progress if response == "p"
  puts "One Karma Point will get you six minutes of freedom. How many points would you like to spend?" if response == "s"
  if (response != "p" && response != "s")
    puts "Goodbye"
    exit 
  end
  redeemed_points = gets.chomp.to_i
  if redeemed_points > total_points
    puts "You cannot spend more than you have earned, imbecile."
    `say "#{commentary("insult")}"`
    store
  else
    puts "Enter yes if would like to spend #{redeemed_points} Karma Points. Otherwise, just press enter."
    response = gets.chomp.downcase
    if response == "yes"
      @current_daily_check_in.update_attributes! :spent_points => redeemed_points
      @current_daily_check_in.update_attributes! :total_points => total_points
      puts "You have #{total_minutes(redeemed_points)} minutes to do whatever you desire. You have #{total_points} Karma Points remaining. Enjoy."
      `say "#{commentary("compliment")}"`
      exit
    else
      store
    end
  end
end

def star_printer(amount_of_stars)
  stars = ""
  amount_of_stars.times do
    stars << "*"
  end
  stars
end

def progress
  daily_check_ins = DailyCheckIn.where(:user_id => @current_user[:id]).all
  counter = 0
  daily_total_points = 0
  puts "\n   Date      Earned  Spent  Balance   Progress\n"
  until counter == daily_check_ins.length do
    date = daily_check_ins[counter].date
    daily_earned_points = daily_check_ins[counter].physiological_points + daily_check_ins[counter].safety_points + daily_check_ins[counter].esteem_points + daily_check_ins[counter].love_points + daily_check_ins[counter].transcendence_points
    daily_earned_points = "%02d" % daily_earned_points
    daily_spent_points = daily_check_ins[counter].spent_points
    daily_spent_points = "%02d" % daily_spent_points
    daily_total_points = daily_total_points.to_i + daily_earned_points.to_i
    daily_total_points = daily_total_points - daily_spent_points.to_i
    daily_total_points = "%02d" % daily_total_points
    puts "#{date}  |  #{daily_earned_points}  |  #{daily_spent_points}  |   #{daily_total_points}   |  #{star_printer(daily_total_points.to_i)} "
    counter += 1
  end
  puts "\nEnter s to spend Karma Points or press enter to exit."
  response = gets.chomp.downcase
  store if response == "s"
  if response != "s"
    puts "Goodbye"
    exit
  end
end

welcome
date
physiological
safety
esteem
love
transcendence
daily_report
store